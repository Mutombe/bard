# =========================
# BARDIQ JOURNAL - RENDER BLUEPRINT
# =========================
# Deploy using: render blueprint sync

services:
  # =========================
  # BACKEND (Django)
  # =========================
  - type: web
    name: bardiq-api
    runtime: python
    region: frankfurt
    plan: starter
    rootDir: backend
    buildCommand: |
      pip install -r requirements.txt &&
      python manage.py collectstatic --noinput &&
      python manage.py migrate --noinput &&
      python manage.py populate_data
    startCommand: gunicorn config.wsgi:application -c gunicorn.conf.py
    healthCheckPath: /health/
    autoDeploy: true
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.0"
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings.production
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        value: "bardiq-api.onrender.com,.onrender.com"
      - key: CORS_ALLOWED_ORIGINS
        value: "https://bardiq-frontend.onrender.com,https://bardiqjournal.com,http://localhost:3000"
      - key: DATABASE_URL
        sync: false  # Set manually in Render dashboard with Neon connection string
      - key: WEB_CONCURRENCY
        value: "2"
      - key: CONN_MAX_AGE
        value: "0"
      - key: SECURE_SSL_REDIRECT
        value: "True"
      # External API Keys (set manually in Render dashboard)
      - key: YOUTUBE_API_KEY
        sync: false
      - key: ALPHA_VANTAGE_KEY
        sync: false
      - key: POLYGON_API_KEY
        sync: false
      - key: NEWSAPI_KEY
        sync: false
      - key: UNSPLASH_ACCESS_KEY
        sync: false

  # =========================
  # FRONTEND (Next.js)
  # =========================
  - type: web
    name: bardiq-frontend
    runtime: node
    region: frankfurt
    plan: starter
    rootDir: frontend
    buildCommand: npm install && npm run build
    startCommand: npm start
    healthCheckPath: /
    autoDeploy: true
    envVars:
      - key: NODE_VERSION
        value: "20"
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_API_URL
        value: "https://bardiq-api.onrender.com"
      - key: NEXT_PUBLIC_WS_URL
        value: "wss://bardiq-api.onrender.com/ws"
      - key: PORT
        value: "3000"

  # =========================
  # CRON JOB - News Updates (every 2 hours)
  # =========================
  - type: cron
    name: bardiq-news-updater
    runtime: python
    region: frankfurt
    plan: starter
    rootDir: backend
    schedule: "0 */2 * * *"  # Every 2 hours
    buildCommand: pip install -r requirements.txt
    startCommand: python manage.py populate_data --news-only
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.0"
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings.production
      - key: SECRET_KEY
        fromService:
          name: bardiq-api
          type: web
          envVarKey: SECRET_KEY
      - key: DATABASE_URL
        sync: false
      - key: POLYGON_API_KEY
        sync: false
      - key: NEWSAPI_KEY
        sync: false
      - key: UNSPLASH_ACCESS_KEY
        sync: false

  # =========================
  # CRON JOB - Video Updates (every 4 hours)
  # =========================
  - type: cron
    name: bardiq-video-updater
    runtime: python
    region: frankfurt
    plan: starter
    rootDir: backend
    schedule: "30 */4 * * *"  # Every 4 hours (at :30)
    buildCommand: pip install -r requirements.txt
    startCommand: python manage.py populate_data --videos-only
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.0"
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings.production
      - key: SECRET_KEY
        fromService:
          name: bardiq-api
          type: web
          envVarKey: SECRET_KEY
      - key: DATABASE_URL
        sync: false
      - key: YOUTUBE_API_KEY
        sync: false

  # =========================
  # CRON JOB - Images & Featured (every 3 hours)
  # =========================
  - type: cron
    name: bardiq-images-updater
    runtime: python
    region: frankfurt
    plan: starter
    rootDir: backend
    schedule: "15 */3 * * *"  # Every 3 hours (at :15)
    buildCommand: pip install -r requirements.txt
    startCommand: python manage.py populate_data --images-only
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.0"
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings.production
      - key: SECRET_KEY
        fromService:
          name: bardiq-api
          type: web
          envVarKey: SECRET_KEY
      - key: DATABASE_URL
        sync: false
      - key: UNSPLASH_ACCESS_KEY
        sync: false

# Note: Database is hosted on Neon (external)
# Set DATABASE_URL manually in Render dashboard with your Neon connection string
